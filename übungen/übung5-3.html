<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ü5-2</title>
</head>

<body>
    <h1>Topsort</h1>
    <div id="inputs">
        <label>Neue Beziehung:</label>
        <input id="left" type="text">
        <label>muss vor</label>
        <input id="right" type="text">
        <label>gemacht werden.</label>
        <button id="add">Hinzufügen</button>
        <ul id="prereqdisplay"></ul>
        <div style="padding-top: 15px;">
            <button id="finish">Sortierung Erzeugen</button>
        </div>
    </div>
    <div id="results" style="display: hidden;">
        <p>Aufgaben von oben nach unten abarbeiten:</p>
        <ol id="resultslist"></ol>
    </div>
    <script>
        let left = document.getElementById("left")
        let righ = document.getElementById("right")
        let addbutton = document.getElementById("add")
        let finishbutton = document.getElementById("finish")
        let prereqdisplay = document.getElementById("prereqdisplay")

        let sortablePrereqs = []

        addbutton.addEventListener("click", (evt) => {
            let prereq = left.value;
            let task = right.value;
            sortablePrereqs.push([prereq, task]);
            // Visualization liste updaten. Optional.
            let elem = document.createElement("li")
            let lefttext = document.createElement("code")
            lefttext.innerText = prereq;
            elem.appendChild(lefttext)
            let text = document.createTextNode(" ist vor ")
            elem.appendChild(text)
            let righttext = document.createElement("code")
            righttext.innerText = task;
            elem.appendChild(righttext)
            prereqdisplay.appendChild(elem)
        })

        finishbutton.addEventListener("click", (evt) => {
            addbutton.disabled = true;
            finishbutton.disabled = true;
            
            let sortedTasks = topsort(sortablePrereqs)
            let resultslist = document.getElementById("resultslist")
            for (let task of sortedTasks) {
                let elem = document.createElement("li");
                elem.innerText = task;
                resultslist.appendChild(elem)
            }
            document.getElementById("results").display = "default"
            
        })

        function topsort(arr) {
            var tasks = new Set(arr.flat());
            var directPrereqs = {}
            for (let task of tasks.values()) directPrereqs[task] = new Set()

            for (let [prereq, task] of arr) {
                directPrereqs[task].add(prereq)
            }
            var prerequisites = {}
            function calcPrerequisites(task) {
                if (prerequisites[task] !== undefined) return prerequisites[task];
                let foundPrereqs = new Set(directPrereqs[task]);
                for (let prereq of directPrereqs[task]) {
                    let subprereq = calcPrerequisites(prereq);
                    for (let entry of subprereq) {
                        foundPrereqs.add(entry)
                    }
                }
                prerequisites[task] = foundPrereqs;
                return foundPrereqs;
            }

            function countPrerequisites(task) {
                return calcPrerequisites(task).size
            }

            let result = Array.from(tasks).sort((a, b) => countPrerequisites(a) - countPrerequisites(b))
            return result;
        }
    </script>
</body>

</html>