<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ü6-2</title>
    <script>
        class Vorrang {
            pairs;
            constructor(pairs = []) {
                this.pairs = pairs;
            };
            addPrerequisite(task, prereq) {
                this.pairs.push([prereq, task]);
            }
            [Symbol.iterator]() {
                // Deduplicate Tasks
                var tasks = new Set(this.pairs.flat());
                // Parse direct prerequisites from given pairs
                var directPrereqs = {}
                for (let task of tasks.values()) directPrereqs[task] = new Set()
                for (let [prereq, task] of this.pairs) {
                    directPrereqs[task].add(prereq)
                }
                // Create map that also includes indirect prerequisites
                var prerequisites = new Map()
                function calcPrerequisites(task) {
                    // Cache
                    if (prerequisites.get(task) !== undefined) return prerequisites.get(task);

                    let foundPrereqs = new Set(directPrereqs[task]);
                    for (let prereq of directPrereqs[task]) {
                        let subprereq = calcPrerequisites(prereq);
                        for (let entry of subprereq) {
                            foundPrereqs.add(entry)
                        }
                    }
                    prerequisites.set(task, foundPrereqs);
                    return foundPrereqs;
                }

                function countPrerequisites(task) {
                    return calcPrerequisites(task).size
                }

                return {
                    next() {
                        let minFound = undefined;
                        let minFoundCost = Infinity;
                        for (let task of tasks.values()) {
                            let newCost = countPrerequisites(task);
                            if (newCost >= minFoundCost) continue;
                            minFound = task;
                            minFoundCost = newCost;
                        }
                        if (minFound === undefined) return { done: true }

                        // Gefundenes Element entfernen damit es nicht nochmal gefunden wird
                        tasks.delete(minFound);

                        return {
                            done: false,
                            value: minFound
                        }
                    }
                }
            };
        }
    </script>
</head>

<body>
    <h1>Topsort</h1>
    <div id="inputs">
        <label>Neue Beziehung:</label>
        <input id="left" type="text">
        <label>muss vor</label>
        <input id="right" type="text">
        <label>gemacht werden.</label>
        <button id="add">Hinzufügen</button>
        <ul id="prereqdisplay"></ul>
        <div style="padding-top: 15px;">
            <button id="finish">Sortierung Erzeugen</button>
        </div>
    </div>
    <div id="results" style="display: hidden;">
        <p>Aufgaben von oben nach unten abarbeiten:</p>
        <ol id="resultslist"></ol>
    </div>
    <script>
        let left = document.getElementById("left")
        let righ = document.getElementById("right")
        let addbutton = document.getElementById("add")
        let finishbutton = document.getElementById("finish")
        let prereqdisplay = document.getElementById("prereqdisplay")

        const sortierer = new Vorrang();
        addbutton.addEventListener("click", (evt) => {
            let prereq = left.value;
            let task = right.value;
            sortierer.addPrerequisite(task, prereq)
            // Input clearen
            right.value = ""; left.value = "";
            // Visualization liste updaten. Optional.
            let elem = document.createElement("li")
            let lefttext = document.createElement("code")
            lefttext.innerText = prereq;
            elem.appendChild(lefttext)
            let text = document.createTextNode(" ist vor ")
            elem.appendChild(text)
            let righttext = document.createElement("code")
            righttext.innerText = task;
            elem.appendChild(righttext)
            prereqdisplay.appendChild(elem)
        })

        finishbutton.addEventListener("click", async (evt) => {
            addbutton.disabled = true;
            finishbutton.disabled = true;

            let resultslist = document.getElementById("resultslist")

            for (let task of sortierer) {
                let elem = document.createElement("li");
                elem.innerText = task;
                resultslist.appendChild(elem)

                // 500ms warten um iterator zu demonstrieren
                await new Promise((resolve)=>setTimeout(resolve, 500))
            }

            document.getElementById("results").display = "default"

        })
    </script>
</body>

</html>